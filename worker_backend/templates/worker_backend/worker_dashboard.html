{% load static %}
<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>×“×™×•×•×—×™× | Worker Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{% static 'css/worker/worker_dashboard.css' %}">
</head>
<body>
  <div class="container">
    <h1>ğŸ‘·â€â™‚ï¸ ×“×™×•×•×—×™× ×©×”×•×§×¦×• ××œ×™×š</h1>
    
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>ğŸ†” ID</th>
            <th>ğŸ“ ×›×•×ª×¨×ª</th>
            <th>ğŸ“Š ×¡×˜×˜×•×¡</th>
            <th>âœ… ×¡××Ÿ ×›×”×•×©×œ×</th>
            <th>ğŸšª ×¢×–×•×‘ ××©×™××”</th>
            <th>ğŸ”§ ×¦×™×•×“ ×—×¡×¨/×ª×§×•×œ</th>
            <th>ğŸ›¡ï¸ ×”× ×—×™×•×ª ×‘×˜×™×—×•×ª</th>
            <th>ğŸ—ºï¸ × ×™×•×•×˜</th>
            <th>ğŸ“‹ ×”×¢×¨×•×ª ×¤× ×™××™×•×ª</th>
          </tr>
        </thead>
        <tbody>
          {% for report in reports %}
          <tr>
            <td><strong>{{ report.id }}</strong></td>
            <td>{{ report.title }}</td>
            <td>
              {% if report.status == "×—×“×©" or not report.status %}
                <span class="badge status-new">ğŸ†• ×—×“×©</span>
              {% elif report.status == "×‘×ª×”×œ×™×š" or report.status == "pending" %}
                <span class="badge status-pending">â³ ×‘×ª×”×œ×™×š</span>
              {% elif report.status == "×”×•×©×œ×" or report.status == "done" %}
                <span class="badge status-done">âœ… ×”×•×©×œ×</span>
              {% else %}
                <span class="badge status-other">{{ report.status }}</span>
              {% endif %}
            </td>
            <td class="actions">
              {% if report.status != "done" and report.status != "×”×•×©×œ×" %}
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="mark_done">
                <input type="hidden" name="report_id" value="{{ report.id }}">
                <button type="submit">âœ… ×¡××Ÿ ×›×”×•×©×œ×</button>
              </form>
              {% else %}
                <span class="badge status-done">âœ… ×”×•×©×œ×</span>
              {% endif %}
            </td>
            <td class="actions">
              {% if report.status != "done" and report.status != "×”×•×©×œ×" %}
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="leave_job">
                <input type="hidden" name="report_id" value="{{ report.id }}">
                <button type="submit" class="leave-btn">ğŸšª ×¢×–×•×‘ ××©×™××”</button>
              </form>
              {% else %}
                <span style="color:#aaa;">-</span>
              {% endif %}
            </td>
            <td>
              <div class="equipment-section">
                <div class="section-header">ğŸ”§ ×“×™×•×•×— ×¦×™×•×“</div>
                <form method="post" style="margin-bottom:10px;">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="add_equipment_issue">
                  <input type="hidden" name="report_id" value="{{ report.id }}">
                  <input type="text" name="equipment_issue" placeholder="×“×•×•×— ×¦×™×•×“ ×—×¡×¨/×ª×§×•×œ" class="input-field">
                  <button type="submit">ğŸ“ ×“×•×•×—</button>
                </form>
                <ul class="equip-list">
                  {% for issue in report.equipment_issues %}
                    <li>ğŸ”§ {{ issue.text }} <small style="color:#888;">({{ issue.timestamp }})</small></li>
                  {% endfor %}
                </ul>
              </div>
            </td>
            <td>
              <div class="safety-info">ğŸ›¡ï¸ {{ report.safety_instructions|default:"××™×Ÿ ×”× ×—×™×•×ª ××™×•×—×“×•×ª" }}</div>
            </td>
            <td>
              {% if report.latitude and report.longitude %}
                <a class="map-nav-link" href="{{ report.google_maps_link }}" target="_blank">
                  ğŸ—ºï¸ × ×•×•×˜ ×¢× Google Maps
                </a>
              {% else %}
                <span style="color: #aaa;">âŒ ××™×Ÿ ××™×§×•×</span>
              {% endif %}
            </td>
            <td>
              <div class="notes-section">
                <div class="section-header">ğŸ“‹ ×”×¢×¨×•×ª ×¤× ×™××™×•×ª</div>
                <form method="post" style="margin-bottom:10px;">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="add_internal_note">
                  <input type="hidden" name="report_id" value="{{ report.id }}">
                  <input type="text" name="internal_note" placeholder="×”×•×¡×£ ×”×¢×¨×” ×¤× ×™××™×ª" class="input-field">
                  <button type="submit">ğŸ“ ×”×•×¡×£</button>
                </form>
                <ul class="note-list">
                  {% for note in report.internal_notes %}
                    <li>ğŸ’­ {{ note.note }} <small style="color:#888;">({{ note.timestamp }})</small></li>
                  {% endfor %}
                </ul>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="9" class="empty-state">
              ğŸ“­ ××™×Ÿ ×“×™×•×•×—×™× ×œ×”×¦×’×”
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- MAP OF CURRENT REPORTS -->
    <div class="map-section">
      <h2>ğŸ—ºï¸ ××¤×” ×©×œ ×›×œ ×”×“×™×•×•×—×™× ×‘×“×£ ×–×”</h2>
      <div id="worker-map">
        <div class="loading">
          ×˜×•×¢×Ÿ ××¤×”...
          <div class="spinner"></div>
        </div>
      </div>
    </div>

    <!-- Pagination Controls -->
    <div class="pagination">
      {% for num in page_range %}
        {% if num == page %}
          <button class="selected">{{ num }}</button>
        {% else %}
          <form method="get" style="display:inline;">
            <input type="hidden" name="page" value="{{ num }}">
            <button type="submit">{{ num }}</button>
          </form>
        {% endif %}
      {% endfor %}
    </div>
  </div>

  <!-- Google Maps Script -->
  <script>
    function initWorkerMap() {
      // Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
      const loadingDiv = document.querySelector('.loading');
      if (loadingDiv) {
        loadingDiv.style.display = 'none';
      }

      var map = new google.maps.Map(document.getElementById('worker-map'), {
        center: { lat: 31.2518, lng: 34.7913 },
        zoom: 12,
        styles: [
          {
            featureType: "water",
            elementType: "geometry",
            stylers: [{ color: "#42a5f5" }]
          },
          {
            featureType: "landscape",
            elementType: "geometry",
            stylers: [{ color: "#f5f5f5" }]
          },
          {
            featureType: "road",
            elementType: "geometry",
            stylers: [{ color: "#ffffff" }]
          },
          {
            featureType: "poi",
            elementType: "geometry",
            stylers: [{ color: "#e8f5e8" }]
          }
        ]
      });

      var reports = {{ map_reports|safe }};
      reports.forEach(function(report) {
        if (report.latitude && report.longitude) {
          var marker = new google.maps.Marker({
            position: {lat: report.latitude, lng: report.longitude},
            map: map,
            title: report.title,
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              scale: 12,
              fillColor: getMarkerColor(report.status),
              fillOpacity: 1,
              strokeColor: "#ffffff",
              strokeWeight: 3
            }
          });

          var info = new google.maps.InfoWindow({
            content: `<div style="font-family:'Cairo',sans-serif;font-size:15px;direction:rtl;text-align:right;max-width:250px;">
              <strong style="color:#1565c0;">ğŸ·ï¸ ${report.title}</strong><br>
              <span style="color:#666;">ğŸ“ ××™×§×•×: ${report.latitude.toFixed(5)}, ${report.longitude.toFixed(5)}</span><br>
              <span style="color:#666;">ğŸ“ ×ª×™××•×¨: ${report.description || '××™×Ÿ ×ª×™××•×¨'}</span><br>
              <div style="margin-top:10px;">
                <a href="https://www.google.com/maps/dir/?api=1&destination=${report.latitude},${report.longitude}" 
                   target="_blank" 
                   style="background:#42a5f5;color:white;padding:5px 10px;border-radius:5px;text-decoration:none;font-weight:600;">
                  ğŸ—ºï¸ × ×•×•×˜ ×‘×’×•×’×œ ××¤×•×ª
                </a>
              </div>
            </div>`
          });

          marker.addListener('click', function() { 
            info.open(map, marker); 
          });

          // ØªØ£Ø«ÙŠØ± hover Ù„Ù„Ù…Ø§Ø±ÙƒØ±
          marker.addListener("mouseover", () => {
            marker.setIcon({
              path: google.maps.SymbolPath.CIRCLE,
              scale: 15,
              fillColor: getMarkerColor(report.status),
              fillOpacity: 1,
              strokeColor: "#ffffff",
              strokeWeight: 4
            });
          });

          marker.addListener("mouseout", () => {
            marker.setIcon({
              path: google.maps.SymbolPath.CIRCLE,
              scale: 12,
              fillColor: getMarkerColor(report.status),
              fillOpacity: 1,
              strokeColor: "#ffffff",
              strokeWeight: 3
            });
          });
        }
      });
    }

    function getMarkerColor(status) {
      switch(status) {
        case "×—×“×©": case "new": return "#1976d2";
        case "×‘×ª×”×œ×™×š": case "pending": return "#ffa726";
        case "×”×•×©×œ×": case "done": return "#388e3c";
        default: return "#757575";
      }
    }

    function loadMapScript() {
      var script = document.createElement('script');
      script.src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyDlCLAutdnujjoTEDdpYwIUvOSTluY2rRQ&callback=initWorkerMap";
      script.async = true;
      script.defer = true;
      script.onerror = function() {
        const mapDiv = document.getElementById('worker-map');
        mapDiv.innerHTML = `
          <div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #e74c3c; font-size: 1.1em;">
            âŒ ×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ××ª ×”××¤×”. ×× × ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜.
          </div>
        `;
      };
      document.body.appendChild(script);
    }

    // ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    document.addEventListener('DOMContentLoaded', function() {
      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
      loadMapScript();

      // ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„
      const inputs = document.querySelectorAll('.input-field');
      inputs.forEach(input => {
        input.addEventListener('focus', function() {
          this.style.transform = 'scale(1.02)';
          this.style.transition = 'transform 0.2s ease';
        });
        
        input.addEventListener('blur', function() {
          this.style.transform = 'scale(1)';
        });
      });
    });

    window.onload = function() {
      if (typeof loadMapScript === 'function') {
        loadMapScript();
      }
    };
  </script>
</body>
</html>


